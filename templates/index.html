
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jenkins Self-Healing Dashboard with Analytics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 text-gray-900">
    <div class="container mx-auto p-6">
        <h1 class="text-3xl font-bold mb-6 text-center">ðŸš€ Jenkins Self-Healing Dashboard</h1>

        <div class="grid grid-cols-3 gap-4 mb-6">
            <canvas id="statusChart"></canvas>
            <canvas id="retryChart"></canvas>
            <canvas id="failureChart"></canvas>
        </div>

        <table class="min-w-full bg-white rounded-lg shadow-md">
            <thead>
                <tr>
                    <th class="py-3 px-6 bg-gray-200">Job Name</th>
                    <th class="py-3 px-6 bg-gray-200">Status</th>
                    <th class="py-3 px-6 bg-gray-200">Retries Left</th>
                    <th class="py-3 px-6 bg-gray-200">Action</th>
                </tr>
            </thead>
            <tbody>
                {% for job in jobs %}
                <tr class="text-center border-b">
                    <td class="py-3 px-6">{{ job.name }}</td>
                    <td class="py-3 px-6">{{ job.status }}</td>
                    <td class="py-3 px-6">{{ job.retries_left }}</td>
                    <td class="py-3 px-6">
                        <button onclick="retryJob('{{ job.name }}')" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                            Retry ðŸ”„
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <p class="text-center text-sm text-gray-500 mt-4">Auto-refreshes every 30 seconds</p>
    </div>

<script>
// Initialize Charts
const statusCtx = document.getElementById('statusChart').getContext('2d');
const retryCtx = document.getElementById('retryChart').getContext('2d');
const failureCtx = document.getElementById('failureChart').getContext('2d');

let statusChart, retryChart, failureChart;

function fetchAnalytics(){
    fetch('/analytics')
        .then(response => response.json())
        .then(data => {
            updateStatusChart(data.status_counts);
            updateRetryChart(data.retry_trends);
            updateFailureChart(data.failure_frequency);
        });
}

function updateStatusChart(data){
    if(statusChart) statusChart.destroy();
    statusChart = new Chart(statusCtx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(data),
            datasets: [{
                data: Object.values(data),
                backgroundColor: ['#4CAF50', '#FFC107', '#F44336']
            }]
        }
    });
}

function updateRetryChart(data){
    if(retryChart) retryChart.destroy();
    retryChart = new Chart(retryCtx, {
        type: 'line',
        data: {
            labels: Object.keys(data),
            datasets: [{ label: 'Retries', data: Object.values(data), borderColor: '#3b82f6', fill: false }]
        }
    });
}

function updateFailureChart(data){
    if(failureChart) failureChart.destroy();
    failureChart = new Chart(failureCtx, {
        type: 'bar',
        data: {
            labels: Object.keys(data),
            datasets: [{ label: 'Failures', data: Object.values(data), backgroundColor: '#ef4444' }]
        }
    });
}

function retryJob(jobName) {
    fetch('/retry/' + jobName)
        .then(response => response.json())
        .then(data => alert(data.message))
        .catch(error => alert('Error triggering retry!'));
}

// Fetch analytics data every 30 seconds
fetchAnalytics();
setInterval(fetchAnalytics, 30000);

setTimeout(() => { window.location.reload(); }, 30000);
</script>

</body>
</html>
